{% extends 'main_app/base.html' %}
{% load static %}

{% block title %}
{{ experiment.title }}
{% endblock %}

{% block content %}
<div class="experiment-detail">

  <h2>{{ experiment.title }}</h2>
  <p>{{ experiment.description }}</p>

  {% if experiment.procedure %}
  <button onclick="openPopup()" >How to perform the experiment</button>
    {% endif %}

  {% if experiment.Simulation_Data %}
  <div class="simulation-container">
    <h3>Interactive Simulation</h3>
    <div class="simulation-frame">
      {{ experiment.Simulation_Data|safe }}
    </div>
  </div>
  {% endif %}

  <br>
  {% if experiment.video %}
  <div>
    <h3>Experiment Video</h3>
    <video width="850" controls>
      <source src="{% static experiment.video|cut:'main_app/static/' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  {% endif %}

<br>
  <h3>Comments</h3>
  <ul style="list-style:none; padding:0;">
    {% for comment in comments %}
    <li style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;">
      <div style="display:flex; align-items:flex-start; gap:10px;">
        {% if comment.user.profile.avatar %}
          <img src="{% static comment.user.profile.avatar|cut:'main_app/static/' %}"
               style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
        {% endif %}

        <div style="flex:1;">
          <strong>{{ comment.user.username }}</strong>
          <p style="margin:5px 0;">{{ comment.content }}</p>
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated and not user_commented %}
  <form method="post" action="">
    {% csrf_token %}
    <textarea name="content" placeholder="Add a comment"></textarea>
    <button type="submit">Post Comment</button>
  </form>
  {% endif %}
</div>

<a href="{% url 'experiment_discussion' experiment.id %}" style="display:inline-block; padding:10px 20px; background-color:#8B6F47; color:white; text-decoration:none; border-radius:5px; margin-top:20px;">Joining the discussion</a>

<div id="procedurePopup" class="popup-overlay" onclick="closePopup(event)">
  <div class="popup-content" onclick="event.stopPropagation()">
    <button class="popup-close" onclick="closePopup()">&times;</button>
    <h3>How to perform the experiment</h3>
    <div style="margin-top: 15px; text-align: left;">
      {{ experiment.procedure|safe }}
    </div>
  </div>
</div>


<script>
  function openPopup() {
    document.getElementById('procedurePopup').classList.add('active');
  }

  function closePopup(event) {
    if (!event || event.target.id === 'procedurePopup') {
      document.getElementById('procedurePopup').classList.remove('active');
    }
  }
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closePopup();
    }
  });
</script>

{% endblock %}
