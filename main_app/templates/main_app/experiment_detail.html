{% extends 'main_app/base.html' %}
{% load static %}

{% block title %}
{{ experiment.title }}
{% endblock %}

{% block content %}
<div class="experiment-detail">

  <h2>{{ experiment.title }}</h2>
  <p>{{ experiment.description }}</p>

  {% if experiment.procedure %}
  <button onclick="openPopup()">How to perform the experiment</button>
  {% endif %}

  {% if experiment.Simulation_Data %}
  <div class="simulation-container">
    <h3>Interactive Simulation</h3>
    <div class="simulation-frame">
      {{ experiment.Simulation_Data|safe }}
    </div>
  </div>
  {% endif %}

  <br>
  {% if experiment.video %}
  <div>
    <h3>Experiment Video</h3>
    <video width="850" controls>
      <source src="{% static experiment.video|cut:'main_app/static/' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>
  {% endif %}

  <br>
  <h3>Comments</h3>
  <ul style="list-style:none; padding:0;">
    {% for comment in comments %}
    <li style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;">
      <div style="display:flex; align-items:flex-start; gap:10px;">
        {% if comment.user.profile.avatar %}
          <img src="{% static comment.user.profile.avatar|cut:'main_app/static/' %}"
               style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
        {% endif %}

        <div style="flex:1;">
          <strong>{{ comment.user.username }}</strong>

          <div id="comment-{{ comment.id }}-text">
            <p style="margin:5px 0;">{{ comment.content }}</p>
          </div>

          <div id="comment-{{ comment.id }}-edit" style="display:none;">
            <form method="post" action="{% url 'edit_comment' comment.id %}">
              {% csrf_token %}
              <textarea name="content" style="width:100%; height:60px;">{{ comment.content }}</textarea>
              <button type="submit" style="padding:3px 8px; margin-right:5px;">Save</button>
              <button type="button" onclick="cancelEdit({{ comment.id }})" style="padding:3px 8px;">Cancel</button>
            </form>
          </div>

          {% if user == comment.user %}
          <div style="margin-top:5px;">
            <button onclick="editComment({{ comment.id }})" style="padding:8px 16px; background-color:#8B6F47; color:white; border:none; border-radius:4px; cursor:pointer;">Edit</button>
            <button onclick="showDeleteModal({{ comment.id }})" style="padding:8px 16px; background-color:#8B6F47; color:white; border:none; border-radius:4px; cursor:pointer;">Delete</button>
          </div>
          {% endif %}
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>

  {% if user.is_authenticated and not user_commented %}
  <form method="post" action="">
    {% csrf_token %}
    <textarea name="content" placeholder="Add a comment"></textarea>
    <button type="submit">Post Comment</button>
  </form>
  {% endif %}
</div>

<a href="{% url 'experiment_discussion' experiment.id %}" style="display:inline-block; padding:10px 20px; background-color:#8B6F47; color:white; text-decoration:none; border-radius:5px; margin-top:20px;">Joining the discussion</a>


<div id="procedurePopup" class="popup-overlay" onclick="closePopup(event)">
  <div class="popup-content" onclick="event.stopPropagation()">
    <button class="popup-close" onclick="closePopup()">&times;</button>
    <h3>How to perform the experiment</h3>
    <div style="margin-top: 15px; text-align: left; white-space: pre-line;">
      {{ experiment.procedure|safe }}
    </div>
  </div>
</div>

<div id="deleteModal" class="popup-overlay" style="display:none;">
  <div class="popup-content" style="max-width:400px;" onclick="event.stopPropagation()">
    <h3 style="margin-top:0; color:#8B6F47;">Confirm Delete</h3>
    <p style="margin:15px 0;">Are you sure you want to delete this comment? </p>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
      <button onclick="closeDeleteModal()" style="padding:8px 16px; background-color:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">Cancel</button>
      <form id="deleteForm" method="post" style="display:inline; margin:0;">
        {% csrf_token %}
        <button type="submit" style="padding:8px 16px; background-color:#8B6F47; color:white; border:none; border-radius:4px; cursor:pointer;">Delete</button>
      </form>
    </div>
  </div>
</div>

<script>
  function openPopup() {
    document.getElementById('procedurePopup').classList.add('active');
  }

  function closePopup(event) {
    if (!event || event.target.id === 'procedurePopup') {
      document.getElementById('procedurePopup').classList.remove('active');
    }
  }

  function editComment(commentId) {
    document.getElementById('comment-' + commentId + '-text').style.display = 'none';
    document.getElementById('comment-' + commentId + '-edit').style.display = 'block';
  }

  function cancelEdit(commentId) {
    document.getElementById('comment-' + commentId + '-text').style.display = 'block';
    document.getElementById('comment-' + commentId + '-edit').style.display = 'none';
  }

  function showDeleteModal(commentId) {
    const modal = document.getElementById('deleteModal');
    const form = document.getElementById('deleteForm');
    form.action = '/comment/delete/' + commentId + '/';
    modal.style.display = 'flex';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closePopup();
      closeDeleteModal();
    }
  });

  document.getElementById('deleteModal').addEventListener('click', function(event) {
    if (event.target.id === 'deleteModal') {
      closeDeleteModal();
    }
  });
</script>

{% endblock %}
